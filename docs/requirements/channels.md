# MessagePusher 消息渠道需求文档

本文档详细描述了 MessagePusher 项目支持的各种消息渠道的需求和实现细节。

## 渠道概述

MessagePusher 支持多种消息推送渠道，包括但不限于 Telegram、Bark、PushDeer 等。系统设计为可扩展的架构，允许轻松添加新的渠道类型。

## 预设渠道类型

### 1. Telegram

通过 Telegram Bot API 发送消息。

#### 配置参数

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| bot_token | string | 是 | Telegram Bot 的访问令牌 |
| chat_id | string | 是 | 目标聊天 ID |
| parse_mode | string | 否 | 消息解析模式（Markdown/HTML） |
| disable_notification | boolean | 否 | 是否静默发送 |

#### 消息格式

```
标题
------
正文内容

[查看完整内容](链接)
```

#### 特性支持

- 支持 Markdown 和 HTML 格式
- 支持发送图片和文件
- 支持消息预览
- 最大消息长度：4096 字符

### 2. Bark

通过 Bark 服务发送通知到 iOS 设备。

#### 配置参数

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| server | string | 否 | Bark 服务器地址，默认为 https://api.day.app |
| device_key | string | 是 | 设备密钥 |
| group | string | 否 | 消息分组 |
| icon | string | 否 | 图标 URL |
| sound | string | 否 | 提示音 |
| isArchive | boolean | 否 | 是否保存到历史记录，默认为 1 |
| level | string | 否 | 时效性通知等级，可选值：active、timeSensitive、passive |
| forceFocus | boolean | 否 | 是否强提醒（突破专注模式和静音模式），默认为 false |

#### 消息格式

标题和内容直接发送，URL 作为点击通知后的跳转链接。

#### 特性支持

- 支持自定义提示音
- 支持消息分组
- 支持自定义图标
- 支持强提醒功能（突破专注模式和静音模式）
- 支持时效性通知等级设置
- 最大消息长度：约 1000 字符

### 3. PushDeer

通过 PushDeer 服务发送通知到多种设备。

#### 配置参数

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| server | string | 否 | PushDeer 服务器地址，默认为官方服务器 |
| push_key | string | 是 | 推送密钥 |
| type | string | 否 | 消息类型（text/markdown） |

#### 消息格式

标题和内容合并发送，URL 作为附加信息。

#### 特性支持

- 支持 Markdown 格式
- 支持多设备推送
- 最大消息长度：约 10000 字符

## 自定义渠道

用户可以配置自定义渠道，通过 HTTP 请求发送消息到任意支持的服务。

### 配置参数

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| name | string | 是 | 渠道名称 |
| url | string | 是 | 请求 URL |
| method | string | 是 | HTTP 方法（GET/POST） |
| headers | object | 否 | 请求头 |
| body_template | string | 否 | 请求体模板 |
| success_codes | array | 否 | 成功状态码列表 |
| success_response | string | 否 | 成功响应内容（支持正则表达式） |

### 请求体模板

自定义渠道支持使用模板变量构建请求体，例如：

```json
{
  "title": "{{title}}",
  "content": "{{content}}",
  "url": "{{url}}",
  "timestamp": "{{timestamp}}"
}
```

支持的变量包括：
- `{{title}}` - 消息标题
- `{{content}}` - 消息内容
- `{{url}}` - 原始链接
- `{{view_url}}` - 查看完整内容的链接
- `{{timestamp}}` - 当前时间戳
- `{{random}}` - 随机字符串

## 代理支持

每个渠道可以单独配置 HTTP 或 SOCKS5 代理。

### HTTP 代理配置

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| type | string | 是 | 代理类型，固定为 "http" |
| host | string | 是 | 代理服务器主机名或 IP |
| port | number | 是 | 代理服务器端口 |
| username | string | 否 | 认证用户名 |
| password | string | 否 | 认证密码 |

### SOCKS5 代理配置

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| type | string | 是 | 代理类型，固定为 "socks5" |
| host | string | 是 | 代理服务器主机名或 IP |
| port | number | 是 | 代理服务器端口 |
| username | string | 否 | 认证用户名 |
| password | string | 否 | 认证密码 |

## 消息长度限制

每个渠道可以设置最大消息长度，超过限制的内容会被截断，并添加查看完整内容的链接。

### 截断策略

1. 如果消息标题超过限制，保留标题前部分，并添加省略号
2. 如果消息内容超过限制，保留内容前部分，并添加省略号和查看链接
3. 确保截断后的消息仍然包含必要的上下文信息

## 错误处理

### 重试机制

对于发送失败的消息，系统会根据配置进行重试：

1. 默认重试次数：3 次
2. 重试间隔：指数退避（如 1 分钟、2 分钟、4 分钟）
3. 重试条件：可配置哪些错误类型需要重试

### 错误日志

详细记录发送失败的原因，包括：

1. HTTP 状态码
2. 错误响应内容
3. 异常堆栈（如果适用）
4. 请求和响应头信息

## 渠道状态监控

系统会监控各个渠道的状态和性能：

1. 成功率统计
2. 平均响应时间
3. 错误类型分布
4. 每日/每周/每月发送量

## 安全考虑

1. 所有渠道配置中的敏感信息（如令牌、密钥）都应加密存储
2. 代理配置中的认证信息同样需要加密
3. 日志中应脱敏敏感信息
4. 使用 HTTPS 进行所有外部通信

## 扩展性设计

渠道模块采用插件架构，便于添加新的渠道类型：

1. 定义统一的渠道接口
2. 每种渠道类型实现该接口
3. 使用工厂模式创建渠道实例
4. 支持动态加载渠道插件

## 实现建议

1. 使用异步 HTTP 客户端，提高并发处理能力
2. 实现请求限流，避免触发第三方服务的速率限制
3. 使用连接池，减少连接建立的开销
4. 实现熔断机制，防止因单个渠道故障影响整个系统 