# MessagePusher 系统流程文档

本文档详细描述了 MessagePusher 系统的完整使用流程，从用户注册到消息推送的全过程。

## 用户认证流程

### 1. 初始管理员设置

- 系统首次启动时，会根据配置文件创建默认管理员账户
- 如果配置文件中未指定管理员信息，系统会创建默认管理员账户（用户名：admin）并生成随机密码
- 随机生成的密码会显示在系统日志中，管理员需要在首次登录后立即修改
- 管理员账户拥有系统的完整管理权限

### 2. 用户登录/注册

- 用户访问HTTP管理界面
- 系统要求用户输入username
- 如果username不存在且系统允许自注册，系统创建新的普通用户账户
- 如果username不存在且系统不允许自注册，系统显示错误信息
- 如果username已存在，系统要求用户输入密码进行验证
- 验证成功后，系统根据用户角色（管理员/普通用户）显示相应的界面和功能
- 管理员用户可以看到系统管理功能和所有用户数据
- 普通用户只能看到个人数据和功能

### 3. 用户权限管理

- 管理员可以创建新用户账户，并设置其角色（管理员/普通用户）
- 管理员可以修改现有用户的角色和状态（活跃/禁用）
- 管理员可以重置用户密码
- 系统记录用户权限变更的操作日志
- 普通用户无法修改自己的角色，只能管理个人信息和密码

## 系统配置流程

### 4. 消息渠道配置

- 用户可以配置多个消息推送渠道，数量不受限制
- 系统提供预设模板：Telegram、Bark、PushDeer等
- 用户可以自定义渠道，指定接口地址和推送格式
- 每个渠道可以单独配置HTTP/SOCKS5代理
- 用户可以为每个渠道设置最大消息长度，超过长度的部分会被截断
- 被截断的内容可通过系统生成的HTTP链接查看完整内容

### 5. AI渠道配置

- 用户可以选择性地添加AI渠道，数量不受限制
- 用户需要配置AI的API接口地址和认证信息
- 用户可以自定义Prompt（系统也提供全局默认Prompt）
- 每个AI渠道可以单独配置HTTP/SOCKS5代理

### 6. API密钥管理

- 用户可以生成多个API密钥
- 每个API可以配置默认的消息渠道（可以是多个）
- 每个API可以配置默认的AI渠道（可选）
- 这些默认配置在API调用时如果未指定特定参数，则会使用默认值
- 用户可以随时修改API密钥的名称、默认渠道和AI设置
- 用户可以启用或禁用API密钥，而不必删除它
- 用户可以删除不再需要的API密钥
- 系统会记录每个API密钥的使用历史和统计信息

## 消息处理流程

### 7. API调用

- 用户通过HTTP请求调用API（支持POST和GET方法）
- 请求必须包含以下参数之一：标题、正文、链接
- 可以指定要使用的渠道编号（可以是多个，格式如"1|2|3"）
- 可以指定要使用的AI编号（只能指定一个）
- 如果未指定渠道或AI，系统使用API的默认配置

### 8. 消息存储

- 系统收到API请求后，首先将消息内容和配置信息写入数据库
- 如果消息包含URL链接，系统会抓取链接内容并保存到数据库

### 9. AI处理

- 如果API请求指定了AI处理，系统会调用对应的AI服务
- AI服务使用配置的Prompt处理消息内容
- AI处理结果保存到数据库

### 10. 消息推送

- 系统将消息发送到指定的渠道
- 如果消息内容超过渠道设置的最大长度，系统会截断内容
- 系统会在消息中包含一个链接，用户可以通过该链接查看完整内容和AI解读结果

## 数据流图

```
+-------------+     +----------------+     +----------------+
|  用户界面   |---->| 渠道/AI配置    |---->|  API密钥管理  |
+-------------+     +----------------+     +----------------+
                                                  |
                                                  v
+----------------+     +----------------+     +----------------+
| 消息推送      |<----| AI处理         |<----|  API调用      |
+----------------+     +----------------+     +----------------+
       |                      |                      |
       v                      v                      v
+----------------------------------------------------------+
|                        数据库                           |
+----------------------------------------------------------+
```

## 用例场景

### 场景1：新闻摘要推送

1. 用户配置了Telegram和Bark两个消息渠道
2. 用户配置了OpenAI的API作为AI渠道
3. 用户生成了一个API，默认使用Telegram渠道和OpenAI AI
4. 用户通过API发送一个新闻网页链接
5. 系统抓取网页内容并保存
6. 系统调用OpenAI分析新闻内容，生成摘要
7. 系统将新闻标题、摘要和查看完整内容的链接发送到Telegram
8. 用户可以通过链接查看完整的新闻内容和AI分析结果

### 场景2：多渠道通知

1. 用户配置了Telegram、Bark和PushDeer三个渠道
2. 用户生成了一个API，未设置默认渠道
3. 用户通过API发送一条通知，指定使用渠道"1|3"（Telegram和PushDeer）
4. 系统将通知发送到指定的两个渠道
5. 如果通知内容超过任一渠道的最大长度限制，系统会截断内容并提供完整查看链接

### 场景3：API密钥生命周期管理

1. 用户创建了一个名为"新闻推送"的API密钥，配置默认使用Telegram渠道
2. 用户使用该API密钥发送了多条消息
3. 用户决定添加Bark作为默认渠道，通过Web界面修改API密钥配置
4. 系统更新API密钥配置，后续使用该密钥的请求将同时发送到Telegram和Bark
5. 用户发现该API密钥被滥用，临时将其禁用
6. 系统拒绝所有使用该API密钥的请求，直到用户重新启用
7. 用户不再需要该API密钥，通过Web界面将其删除
8. 系统永久删除该API密钥，任何使用该密钥的请求都将被拒绝

## 错误处理

1. **渠道发送失败**：系统会记录失败原因，并在用户界面中显示发送状态
2. **AI处理失败**：系统会记录错误信息，并继续发送原始消息内容
3. **URL抓取失败**：系统会记录错误信息，并发送可用的消息部分
4. **代理连接失败**：系统会尝试直接连接，如果仍然失败则记录错误 